# Getting started on Jpsi analysis

# *** 1. Convert CMS AOD file (Data/MC) into plain root in lxplus ***
  1-1) Set up CMS environment (see details in CMS workbook chapter 1.3) in lxplus work area (the exactly same CMSSW package as that in official real data production should be used)
       a) source /cvmfs/cms.cern.ch/cmsset_default.sh
       b) export SCRAM_ARCH=slc7_amd64_gcc700 (set the same slc-gcc version as the needed CMSSW release, check slc-gcc version by using 'scram list -a | grep CMSSW_10_3_3_patch1')
       c) cmsrel CMSSW_10_3_3_patch1 # only needs to be done once
       d) cd CMSSW_10_3_3_patch1/src
       e) cmsenv

  1-2) Install Rice VertexCompositeAnalysis package
       a) In 'CMSSW_10_3_3_patch1/src', git clone -b 10_3_X https://github.com/davidlw/VertexCompositeAnalysis
       b) cd VertexCompositeAnalysis
       c) scram b -j8
       d) cd VertexCompositeProducer/test
       e) cmsRun PbPbSkimAndTree2018_DiMuContBothGammaGamma_mc_cfg.py
    
  1-3) Submit crab jobs (See details in https://twiki.cern.ch/twiki/bin/view/CMSPublic/WorkBookCRAB3Tutorial)
       The crab job configuration files used for jpsi analysis can be found in 'jpsiAnaCode/crabJobConfig' directory 
       Caveat: There is NO maximum HF tower energy filter in PbPbSkimAndTree2018_DiMuContBothGammaGamma_mc_cfg.py, please pay attention to the efficiency correction of leading HF energy veto


# The root files of DATA&MC, generated by VertexCompositeAnalysis package, can be found .
# The analysis codes in following steps are based on the plain root gerenated by VertexCompositeAnalysis package. Therefore, copy the rootfiles under '/storage1/users/sy54/PbPb2018_DiMuTrees' in bonner lab cluster to the 'jpsiAnaCode/rootfiles' directory.


# *** 2. DATA analysis (please DO NOT change the relative path of the directories) ***
  2-1) cd jpsiAnaCode/anaData
  2-2) execute 'root -l -b -q anaEvt.C+' to produce various histograms, e.g., ZDC distributions, pair mass vs. pair pt vs. pair rapidity distributions... (One valid root file generated by VertexCompositeAnalysis package is needed)
  2-3) execute 'root -l -b -q plotJpsiQA.C+' to produces QA plots, including the pair mass (pt) vs. rapitiy (neutron multiplicity)...
  2-4) execute 'root -l -b -q plotAcc.C+' to check the daughter muon kinematics and give one an idea how the acceptance boundaries of soft muon and triggered muon are determined


# *** 3. neutron decouple ***
  3-1) cd jpsiAnaCode/neuDecouple
  3-2) execute 'root -l -b -q plotZDC.C+' to decouple neutron numbers. In UPC Jpsi analysis, 0n0n, 0nXn, XnXn with X>=1 will be used. In this case both the efficiency and purity of 0n and Xn are ~100% according to the fit results
       NOTE, 'plotZDC.C' analyzes the output root file of step 2-2)


# *** 4. momentum smearing ***
  This step might not be needed, depending how we extract the raw signal. 


# *** 5. Generate acceptance*efficiency correction factors and templates of various processes ***


# *** 6. Signal extraction ***


# *** 7. Pileup correction (TBD) ***
